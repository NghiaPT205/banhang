<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quản lý người dùng</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --blue:#0d6efd;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    body{ background:#f3f5f9; }
    .wrap{ max-width:1200px; margin:40px auto; padding:0 16px; }
    .card-main{
      border:0; border-radius:10px; overflow:hidden; box-shadow:var(--shadow);
    }
    .topbar{
      background:var(--blue);
      color:#fff;
      padding:12px 18px;
      font-weight:700;
      display:flex; align-items:center; gap:10px;
    }
    .btn-add{
      background:#1f9d55; border:0;
      box-shadow:0 6px 16px rgba(31,157,85,.25);
    }
    .btn-add:hover{ filter:brightness(.95); }

    .table-wrap{
      border-radius:10px; overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    thead th{
      background:#1f232a !important;
      color:#fff !important;
      padding:14px 12px !important;
      border-bottom:0 !important;
      font-weight:700;
    }
    tbody td{ padding:12px !important; vertical-align:middle; }

    .badge-status{
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }
    .badge-active{ background:#198754; }
    .badge-lock{ background:#6c757d; }

    .btn-action{
      padding:6px 10px; border-radius:6px; border:0;
      font-weight:700;
    }
    .btn-edit{ background:#ffc107; }
    .btn-del{ background:#dc3545; color:#fff; }
    .btn-edit:hover,.btn-del:hover{ filter:brightness(.95); }

    /* Modal giống ảnh */
    .modal-content{ border:0; border-radius:12px; box-shadow:var(--shadow); }
    .modal-header{
      background:var(--blue);
      color:#fff;
      border-bottom:0;
      padding:12px 16px;
    }
    .modal-title{ font-weight:800; }
    .btn-close-white{ filter: invert(1) grayscale(100%); opacity:.9; }
    .modal-footer{ border-top:0; padding:12px 16px 16px; }
    .btn-save{ background:var(--blue); border:0; min-width:90px; }
    label.form-label{ font-weight:700; color:#31363f; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card card-main">
      <div class="topbar">
        <i class="bi bi-person-badge"></i>
        <span>Quản lý người dùng &amp; phân quyền</span>
      </div>

      <div class="card-body p-3 p-md-4">
        <button id="btnAdd" class="btn btn-add text-white">
          <i class="bi bi-plus-lg me-1"></i> Thêm người dùng
        </button>

        <div class="table-wrap mt-3">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th style="width:28%">Username</th>
                <th style="width:28%">Họ tên</th>
                <th style="width:18%">Quyền</th>
                <th style="width:16%">Trạng thái</th>
                <th style="width:10%">Chức năng</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:520px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thông tin người dùng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4">
          <form id="form" class="needs-validation" novalidate>
            <input type="hidden" id="id">

            <div class="mb-3">
              <label class="form-label">Tên người dùng</label>
              <input class="form-control" id="username" required>
              <div class="invalid-feedback">Vui lòng nhập username.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Mật khẩu</label>
              <input type="password" class="form-control" id="password" placeholder="Để trống nếu không đổi">
            </div>

            <div class="mb-3">
              <label class="form-label">Họ và tên</label>
              <input class="form-control" id="fullname" required>
              <div class="invalid-feedback">Vui lòng nhập họ tên.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Quyền</label>
              <select class="form-select" id="role" required>
                <option>Admin</option>
                <option selected>Nhân viên</option>
                <option>Khách hàng</option>
              </select>
            </div>

            <div class="mb-1">
              <label class="form-label">Trạng thái</label>
              <select class="form-select" id="status" required>
                <option selected>Hoạt động</option>
                <option>Tạm khóa</option>
              </select>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button id="btnSave" class="btn btn-save text-white">Lưu</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const KEY = "ui_users_demo_v1";
    const seed = [
      {id:1, username:"admin", fullname:"Quản trị hệ thống", role:"Admin", status:"Hoạt động"},
      {id:2, username:"nha@gmail.com", fullname:"Viên Thanh Nhã", role:"Nhân viên", status:"Hoạt động"},
    ];

    function load(){
      const raw = localStorage.getItem(KEY);
      if(!raw){ localStorage.setItem(KEY, JSON.stringify(seed)); return [...seed]; }
      try{ return JSON.parse(raw) || []; }catch{ return []; }
    }
    function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

    let users = load();
    const tbody = document.getElementById("tbody");

    function badge(status){
      const active = status === "Hoạt động";
      return `<span class="badge badge-status ${active ? "badge-active":"badge-lock"}">${active?"Hoạt động":"Tạm khóa"}</span>`;
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function render(){
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${esc(u.username)}</td>
          <td>${esc(u.fullname)}</td>
          <td>${esc(u.role)}</td>
          <td>${badge(u.status)}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn-action btn-edit" data-act="edit" data-id="${u.id}">Sửa</button>
              <button class="btn-action btn-del" data-act="del" data-id="${u.id}">Xóa</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    const modal = new bootstrap.Modal(document.getElementById("userModal"));
    const form = document.getElementById("form");

    const elId = document.getElementById("id");
    const elUsername = document.getElementById("username");
    const elPassword = document.getElementById("password");
    const elFull = document.getElementById("fullname");
    const elRole = document.getElementById("role");
    const elStatus = document.getElementById("status");

    document.getElementById("btnAdd").onclick = () => {
      form.reset();
      form.classList.remove("was-validated");
      elId.value = "";
      elRole.value = "Nhân viên";
      elStatus.value = "Hoạt động";
      elPassword.value = "";
      modal.show();
      setTimeout(()=>elUsername.focus(),200);
    };

    tbody.onclick = (e) => {
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const id = Number(btn.dataset.id);
      const act = btn.dataset.act;
      const u = users.find(x => x.id === id);
      if(!u) return;

      if(act === "edit"){
        form.reset();
        form.classList.remove("was-validated");
        elId.value = u.id;
        elUsername.value = u.username;
        elFull.value = u.fullname;
        elRole.value = u.role;
        elStatus.value = u.status;
        elPassword.value = "";
        modal.show();
        setTimeout(()=>elUsername.focus(),200);
      }

      if(act === "del"){
        if(confirm(`Xóa người dùng "${u.username}"?`)){
          users = users.filter(x => x.id !== id);
          save(users);
          render();
        }
      }
    };

    document.getElementById("btnSave").onclick = () => {
      form.classList.add("was-validated");
      if(!form.checkValidity()) return;

      const id = elId.value ? Number(elId.value) : null;
      const username = elUsername.value.trim();
      const fullname = elFull.value.trim();

      // check trùng username
      const dup = users.some(x => x.username.toLowerCase() === username.toLowerCase() && x.id !== id);
      if(dup){ alert("Username đã tồn tại!"); return; }

      if(id === null){
        const nextId = users.length ? Math.max(...users.map(x=>x.id)) + 1 : 1;
        users.push({ id: nextId, username, fullname, role: elRole.value, status: elStatus.value });
      }else{
        const idx = users.findIndex(x => x.id === id);
        users[idx] = { ...users[idx], username, fullname, role: elRole.value, status: elStatus.value };
      }

      save(users);
      render();
      modal.hide();
    };

    render();
  </script>
</body>
</html>
